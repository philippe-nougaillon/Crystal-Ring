<div class="card ">
  <div class="card-header">
    <h2>#<%= @facture.num_chrono %></h2>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col">
        <% if @facture.scan.previewable? %>
          <div class="shadow p-4 mb-4 bg-white">
            <%= link_to image_tag(@pdf_preview, size: "300x400", class: "img-fluid"), "#", { 'data-toggle': "modal", 'data-target': "#myModal"} %>
          </div>
        <% end %>
      </div>
      
      <div class="col">
        <h5>
          <span class="badge <%= @facture.style %>">
            <%= @facture.workflow_state %>
          </span>
        </h5>
        <br>

        <p>
          <strong>Anomalie:</strong>
          <%= @facture.anomalie.humanize %>
        </p>

        <p>
          <strong>Société:</strong>
          <%= @facture.société %>
        </p>

        <p>
          <strong>PAR:</strong>
          <%= @facture.par %>
        </p>

        <p>
          <strong>Montant € HT:</strong>
          <%= @facture.montantHT %>
        </p>

        <p>
          <strong>Commentaires:</strong>
          <%= @facture.commentaires %>
        </p>
        <br>

        <% if current_user %>
          <p>
            <%= link_to edit_facture_path(@facture), class: "btn btn-sm btn-outline-primary" do %>
              <i class="far fa-edit"></i> Editer 
            <% end %>
          </p>

          <p>          
            <% if @facture.imputée? %>
              <%= link_to facture_url(@facture, format: :pdf), title: "Afficher la facture en PDF", class: "btn btn-sm btn-outline-danger"  do %>
                  <i class="far fa-file-pdf"></i> Preuve PDF
              <% end %>
            <% end %>
          </p>
          <p>
            <% if @facture.validable? && request.domain == "localhost" %>
              <br />
              <% @facture.cibles.each do |c| %>
                <%= link_to "Test Validation #{c.id}", facture_path(@facture, email: c.email) %>
                <br />
              <% end %>
            <% end %>
          </p>
        <% end %>
      </div>

      <div class="col-sm-6">
        <div class="card">
          <div class="card-header">
              <h4>Destinataires</h4>
          </div>
          <div class="card-body">
            <table class="table table-borderless table-sm table-hover">
              <thead>
                <th>Email</th>
                <th>Action</th>
                <th>Commentaires</th>
                <th>Il y a</th>
              </thead>
              <%= render @facture.cibles %>
            </table>
          </div>
        </div>

        <% if (@facture.validable? && params[:email]) %>
            <%= form_tag facture_validation_path(@facture), method: :post do %>
              <div class="card">
                <div class="card-header">
                    <h4>Approbation</h4>
                </div>
                <div class="card-body">
                    <%= hidden_field_tag :email, params[:email] %>
                    
                    <strong><%= label_tag "Signataire" %></strong>
                    <%= params[:email] %>
                    <br><br>

                    <strong><%= label_tag "Commentaires" %></strong>
                    <%= text_area_tag :commentaires %>
                </div>
                <div class="card-footer">
                  <%= submit_tag "Valider", class: "btn btn-sm btn-success" %>
                  <%= submit_tag "Rejeter", class: "btn btn-sm btn-danger" %>
                </div>
              </div>
            <% end %>
          <% end %>
      </div>
      
    </div>
  </div>
</div>
<br />

<% if current_user.try(:admin?) %>
  <h3>Audit trail</h3>
  <p>
    <table class="table table-hover">
      <%= render  partial: 'tools/audit', 
                  collection: @facture
                                  .own_and_associated_audits
                                  .includes(:user)
                                  .reorder(Arel.sql("audits.id DESC")) %>
    </table>
  </p>
<% end %>

<!-- The Modal -->
<div class="modal fade" id="myModal">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">#<%= @facture.num_chrono %></h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <%= image_tag @pdf_preview %>
      </div>
    </div>
  </div>
</div>